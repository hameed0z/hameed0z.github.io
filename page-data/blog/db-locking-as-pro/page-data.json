{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/db-locking-as-pro","result":{"data":{"markdownRemark":{"html":"<p>Today we are discussing a very important topic which is the pessimistic database concurrency control.\nFirst of all, we need to understand the issues without concurrency control\nlet's assume we have a database column that has very important value, money for example</p>\n<p>and based on this value we will take certain decisions\nbut how we can be 100% sure that no other transaction is currently messing up with a value?</p>\n<h2>Use Case</h2>\n<p>we have a balance column in the wallet table\nand we have an endpoint that connects to the DB and reads the latest balance value then increases it by 10$.</p>\n<p>we could have multiple transactions increasing the balance at the same time\nbut in this case, all the transactions will override each other.\nto prevent this issue we use a pessimistic lock over the columns that we need to update</p>\n<h2>Locks</h2>\n<p>a pessimistic lock does intention exclusive record locking (IX) which means no other DB connection can read or write on this record until you finish working on it and commit the changes.\nand to do so we use the <code>FOR UPDATE</code> keyword</p>\n<pre class=\"light-default-light vscode-highlight\" data-language=\"sql\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk4\">SELECT</span><span class=\"mtk1\"> * </span><span class=\"mtk4\">FROM</span><span class=\"mtk1\"> WALLET </span><span class=\"mtk4\">WHERE</span><span class=\"mtk1\"> ID=</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> FOR </span><span class=\"mtk4\">UPDATE</span><span class=\"mtk1\">;</span></span></code></pre>\n<p>well, the above might be an issue in so many cases but in our case its an advantage\nwe need to prevent transactions from a race condition</p>\n<h2>Tutorial</h2>\n<p>this example will be written using nodejs so it's better to be familiar with js</p>\n<ul>\n<li>make concurrency test DB on your local machine</li>\n<li>\n<p>clone the tutorial <a href=\"https://github.com/hameed0z/concurrency-tutorial\">repository</a></p>\n<pre class=\"light-default-light vscode-highlight\" data-language=\"bash\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk1\">~:$ git clone https://github.com/hameed0z/concurrency-tutorial.git</span></span></code></pre>\n</li>\n<li>\n<p>change the directory to the tutorial repo and create <code>.env</code> file</p>\n<pre class=\"light-default-light vscode-highlight\" data-language=\"bash\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk1\">~:$ </span><span class=\"mtk10\">cd</span><span class=\"mtk1\"> concurrency-tutorial</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">~:$ nano .env</span></span></code></pre>\n</li>\n<li>\n<p>install the dependencies and run the app</p>\n<pre class=\"light-default-light vscode-highlight\" data-language=\"bash\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk1\">~:$ npm i &amp;&amp; npm start</span></span></code></pre>\n<p>at this point, you should have the app up and running on port <code>3030</code></p>\n</li>\n</ul>\n<h3>Problem endpoint</h3>\n<p>I created a problem endpoint to be able to examine the problem</p>\n<pre class=\"light-default-light vscode-highlight\" data-language=\"js\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk3\">// endpoint that have concurrency problem</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk12\">app</span><span class=\"mtk1\">.</span><span class=\"mtk10\">put</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#39;/problem/:id/:balance&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">req</span><span class=\"mtk1\">, </span><span class=\"mtk12\">res</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\"> = </span><span class=\"mtk9\">Number</span><span class=\"mtk1\">(</span><span class=\"mtk12\">req</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk9\">Number</span><span class=\"mtk1\">(</span><span class=\"mtk12\">req</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk10\">getConnection</span><span class=\"mtk1\">(</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\">, </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">beginTransaction</span><span class=\"mtk1\">(</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">query</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#96;SELECT * FROM WALLET WHERE ID=</span><span class=\"mtk4\">${</span><span class=\"mtk12\">id</span><span class=\"mtk4\">}</span><span class=\"mtk17\">;&#96;</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">error1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows1</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk9\">console</span><span class=\"mtk1\">.</span><span class=\"mtk10\">log</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#39;[PROBLEM] query:&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows1</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">query</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#96;UPDATE WALLET SET BALANCE = </span><span class=\"mtk4\">${</span><span class=\"mtk12\">rows1</span><span class=\"mtk18\">[</span><span class=\"mtk7\">0</span><span class=\"mtk18\">].</span><span class=\"mtk12\">BALANCE</span><span class=\"mtk18\"> </span><span class=\"mtk1\">+</span><span class=\"mtk18\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk4\">}</span><span class=\"mtk17\"> WHERE ID = </span><span class=\"mtk4\">${</span><span class=\"mtk12\">id</span><span class=\"mtk4\">}</span><span class=\"mtk17\">;&#96;</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">error2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows2</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                    </span><span class=\"mtk9\">console</span><span class=\"mtk1\">.</span><span class=\"mtk10\">log</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#39;[PROBLEM]update :&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows2</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">commit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                        </span><span class=\"mtk14\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                            </span><span class=\"mtk14\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">rollback</span><span class=\"mtk1\">(</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                                </span><span class=\"mtk14\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk12\">err</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                            });</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                        }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">query</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#96;SELECT * FROM WALLET WHERE ID=</span><span class=\"mtk4\">${</span><span class=\"mtk12\">id</span><span class=\"mtk4\">}</span><span class=\"mtk17\">;&#96;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">error3</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows3</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                            </span><span class=\"mtk9\">console</span><span class=\"mtk1\">.</span><span class=\"mtk10\">log</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#39;[PROBLEM]confirmation query:&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows3</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                            </span><span class=\"mtk12\">res</span><span class=\"mtk1\">.</span><span class=\"mtk10\">json</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">row:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rows3</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                        })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                    });</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\"></span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">})</span></span></code></pre>\n<p>if this endpoint is called concurrently the request will override each other</p>\n<h3>Problem endpoint results</h3>\n<p>Our starting point is the wallet table to have the value 10 in its column balance\nI'm using terminator to broadcast multiple curl commands</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/52ce51384276877151cd1c61e69ec37b/a3bed/problem-curl.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.214410226612435%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsSAAALEgHS3X78AAAAg0lEQVQI1w3NSw6CMBRAUdYihbav34Ax1WjEOFChGKP7X8uV4RmdpmahSks1mhos7zHyGQdW53m2ill1/ErhsHzR00x/nrHXF+m+kG8rcllQxye78iBNK80QA0kMWYTkLSkIOXiiFVzfI0qxzxkJEe0DeouUNZs9LiasjxgX6axjLCf+ZWM/mqL/qqwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"curling problem enpoint concurently twice\"\n        title=\"curling problem enpoint concurently twice\"\n        src=\"/static/52ce51384276877151cd1c61e69ec37b/fcda8/problem-curl.png\"\n        srcset=\"/static/52ce51384276877151cd1c61e69ec37b/12f09/problem-curl.png 148w,\n/static/52ce51384276877151cd1c61e69ec37b/e4a3f/problem-curl.png 295w,\n/static/52ce51384276877151cd1c61e69ec37b/fcda8/problem-curl.png 590w,\n/static/52ce51384276877151cd1c61e69ec37b/efc66/problem-curl.png 885w,\n/static/52ce51384276877151cd1c61e69ec37b/c83ae/problem-curl.png 1180w,\n/static/52ce51384276877151cd1c61e69ec37b/a3bed/problem-curl.png 1721w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>As you can see after running 2 concurrent requests\nour balance instead of having the value of 10+10+15 = 35\nit has the value 25 because the second request overrides the first request\nwe can confirm this from the logs too</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/091e6f4b2e885fa3ee1f6192414c253d/bcb8c/problem-logs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.18202502844141%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABnElEQVQoz5VT23KCMBT0OzQJIYQ7KiDKxQHttE/+//9sN1hb22pn+rCTA4Q9m92cRZqmOBxaFEWBJI4RE3Vdoaqq67skJix2uwabTY48N9Dah5QSSqlfWJRlicvlgtPpTOIG680G55cz9vs9MjaLwhBRFGC7LUmWkFzD8/RzQu376LoO4zRSVcruipsVhBBYrVbzKoTEcrnk87W+kT0iXfjGzITD0JOwgO9zo7jb+ETJU4VBEGAcR/T9gOxQIKxCiCyEDHisJIDIXU3PUguZWSjWrol8QPZBaNE0Df07IOVPYcgPnvel5Aduqp8SJjS+Hwa0bUfjqTCMuG5hrf06lls/IG9kUj720IXiCKfThHoORc4eyjuSfxEaF0rfEx3Keg1jPUjNI3tqXh/VfwX0GcowHJE2GaLKYpUyCKMhYsOA7LXm5Rb0WJnrHbzHPekioFd1Xc/BpEmIwLjjKHjKwYN2YEi32qNCZ5OmWndnfyl0RK9vb/Nk7FzaDKftWmw5QSXHb5omDMfjPIprjl5Z5vT7BfUuY3iWDb6P4Ts/y1XiT08eRwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"logs from the problem endpoint\"\n        title=\"logs from the problem endpoint\"\n        src=\"/static/091e6f4b2e885fa3ee1f6192414c253d/fcda8/problem-logs.png\"\n        srcset=\"/static/091e6f4b2e885fa3ee1f6192414c253d/12f09/problem-logs.png 148w,\n/static/091e6f4b2e885fa3ee1f6192414c253d/e4a3f/problem-logs.png 295w,\n/static/091e6f4b2e885fa3ee1f6192414c253d/fcda8/problem-logs.png 590w,\n/static/091e6f4b2e885fa3ee1f6192414c253d/bcb8c/problem-logs.png 879w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>Solution endpoint</h3>\n<p>I also created a solution endpoint to be able to examine the fix</p>\n<pre class=\"light-default-light vscode-highlight\" data-language=\"js\"><code class=\"vscode-highlight-code\"><span class=\"vscode-highlight-line\"><span class=\"mtk3\">// endpoint has the concurrency problem solution</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk12\">app</span><span class=\"mtk1\">.</span><span class=\"mtk10\">put</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#39;/solution/:id/:balance&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">req</span><span class=\"mtk1\">, </span><span class=\"mtk12\">res</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\"> = </span><span class=\"mtk9\">Number</span><span class=\"mtk1\">(</span><span class=\"mtk12\">req</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk9\">Number</span><span class=\"mtk1\">(</span><span class=\"mtk12\">req</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">.</span><span class=\"mtk10\">getConnection</span><span class=\"mtk1\">(</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\">, </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">beginTransaction</span><span class=\"mtk1\">(</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check the  &#96;FOR UPDATE&#96; keywords</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">query</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#96;SELECT * FROM WALLET WHERE ID=</span><span class=\"mtk4\">${</span><span class=\"mtk12\">id</span><span class=\"mtk4\">}</span><span class=\"mtk17\"> FOR UPDATE;&#96;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">error1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows1</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk9\">console</span><span class=\"mtk1\">.</span><span class=\"mtk10\">log</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#39;[SOLUTION] query:&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows1</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">query</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#96;UPDATE WALLET SET BALANCE = </span><span class=\"mtk4\">${</span><span class=\"mtk12\">rows1</span><span class=\"mtk18\">[</span><span class=\"mtk7\">0</span><span class=\"mtk18\">].</span><span class=\"mtk12\">BALANCE</span><span class=\"mtk18\"> </span><span class=\"mtk1\">+</span><span class=\"mtk18\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk4\">}</span><span class=\"mtk17\"> WHERE ID = </span><span class=\"mtk4\">${</span><span class=\"mtk12\">id</span><span class=\"mtk4\">}</span><span class=\"mtk17\">;&#96;</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">error2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows2</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                    </span><span class=\"mtk9\">console</span><span class=\"mtk1\">.</span><span class=\"mtk10\">log</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#39;[SOLUTION] update:&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows2</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">commit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                        </span><span class=\"mtk14\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">err</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                            </span><span class=\"mtk14\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">rollback</span><span class=\"mtk1\">(</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                                </span><span class=\"mtk14\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk12\">err</span><span class=\"mtk1\">;</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                            });</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                        }</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">connection</span><span class=\"mtk1\">.</span><span class=\"mtk10\">query</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#96;SELECT * FROM WALLET WHERE ID=</span><span class=\"mtk4\">${</span><span class=\"mtk12\">id</span><span class=\"mtk4\">}</span><span class=\"mtk17\">;&#96;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">error3</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows3</span><span class=\"mtk1\">) {</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                            </span><span class=\"mtk9\">console</span><span class=\"mtk1\">.</span><span class=\"mtk10\">log</span><span class=\"mtk1\">(</span><span class=\"mtk17\">&#39;[SOLUTION] confirmation query:&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rows3</span><span class=\"mtk1\">);</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                            </span><span class=\"mtk12\">res</span><span class=\"mtk1\">.</span><span class=\"mtk10\">json</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">row:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rows3</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                        })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                    });</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">                })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">            })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">        })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"vscode-highlight-line\"><span class=\"mtk1\">})</span></span></code></pre>\n<p>if this endpoint is called concurrently the requests will run sequentially</p>\n<h3>Solution endpoint results</h3>\n<p>Also here our starting point is the wallet table to have the value 10 in its column balance\nI'm using terminator to broadcast multiple curl commands same as the problem endpoint example</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0e78175d7c24caf84e627bcd38600754/56caf/solution-curl.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.242990654205607%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsSAAALEgHS3X78AAAAQklEQVQI10WKQRKAMAjE/AtSEahgb/z/YdtOPXhLMjk8btgj8G7QLj+rol0NzIwxXniunut1hdi5PTJg9r1EhKrCBKZDHhUcBnrtAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"curling solution enpoint concurently twice\"\n        title=\"curling solution enpoint concurently twice\"\n        src=\"/static/0e78175d7c24caf84e627bcd38600754/fcda8/solution-curl.png\"\n        srcset=\"/static/0e78175d7c24caf84e627bcd38600754/12f09/solution-curl.png 148w,\n/static/0e78175d7c24caf84e627bcd38600754/e4a3f/solution-curl.png 295w,\n/static/0e78175d7c24caf84e627bcd38600754/fcda8/solution-curl.png 590w,\n/static/0e78175d7c24caf84e627bcd38600754/efc66/solution-curl.png 885w,\n/static/0e78175d7c24caf84e627bcd38600754/c83ae/solution-curl.png 1180w,\n/static/0e78175d7c24caf84e627bcd38600754/56caf/solution-curl.png 1712w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>As you can see after running 2 concurrent requests\nthe request with value 15 was processed first and returned the response of a balance equal to 25\nthen the second request with a value of 10 was processed and retune a value of 35\nour balance has the value of 10+10+15 = 35\nwe can confirm this from the logs too</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/56ad39de41335567baf90fe2831aa327/bcb8c/solution-logs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.45733788395904%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB0UlEQVQoz31T25LaMBTjMzr4kji2Q24QEsgCCcuyw/9/kyo70JJ22gdh2RkLnaPjVZ7n6LoOu90Wdd1gsynQti32+z2qqoTnd++zyJsmfE9gbQalNLRWhF5g5b3H/X7H/fsb58tA0RI7CtZNDZMZpGlKJDDGcJ+RayRJ8m/B8HM8DpiuE/quRqoF1j/WEOs1lJAzpFpyNQuF9cV/CQYH58sF4ziiHTq4KoNmidqk0NZABU6H2pkZ4fwp9hJ556tgf5wmTNMVVV9i02YQ3kCwNGFTiE0GSUHh0ghJwZezd4evdeWciz3r+g41G295wWUWIazc+cgte5mz10W+gbMaGffvZS4chuQejweu7OHpdCZO+Lx9RtfNdov+cMDh0HHtmTz/tLacgh22/FYUCcWzpWBI78L+3W5fOA5tHBFL1+FcSvmEguAqhIhcyv+UHHo4DHPKx34Lk1BgLZimhObFCKWW/I9RWTgMKYfyxsuI5mMP33qo0s8J5yynIs8YRGEjwvlfgm+Ic/jBvo3jhLot4Cumy1Qlhzama7hXdM3UpeFAJ3puw7P86O4Nq6qumXAfk67KKqIoCqJkog4Nn2MIoOTe+xzO8RnyTh2fYfoM5bfDn0RRVTe8YasEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"logs from the solution endpoint\"\n        title=\"logs from the solution endpoint\"\n        src=\"/static/56ad39de41335567baf90fe2831aa327/fcda8/solution-logs.png\"\n        srcset=\"/static/56ad39de41335567baf90fe2831aa327/12f09/solution-logs.png 148w,\n/static/56ad39de41335567baf90fe2831aa327/e4a3f/solution-logs.png 295w,\n/static/56ad39de41335567baf90fe2831aa327/fcda8/solution-logs.png 590w,\n/static/56ad39de41335567baf90fe2831aa327/bcb8c/solution-logs.png 879w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<style class=\"vscode-highlight-styles\">\n  :root {\n  --vscode-highlight-padding-v: 1rem;\n  --vscode-highlight-padding-h: 1.5rem;\n  --vscode-highlight-padding-top: var(--vscode-highlight-padding-v);\n  --vscode-highlight-padding-right: var(--vscode-highlight-padding-h);\n  --vscode-highlight-padding-bottom: var(--vscode-highlight-padding-v);\n  --vscode-highlight-padding-left: var(--vscode-highlight-padding-h);\n  --vscode-highlight-border-radius: 8px;\n\n  --vscode-highlight-line-highlighted-background-color: transparent;\n  --vscode-highlight-line-highlighted-border-width: 4px;\n  --vscode-highlight-line-highlighted-border-color: transparent;\n}\n\n.vscode-highlight {\n  overflow: auto;\n  -webkit-overflow-scrolling: touch;\n  padding-top: 1rem;\n  padding-top: var(--vscode-highlight-padding-top);\n  padding-bottom: 1rem;\n  padding-bottom: var(--vscode-highlight-padding-bottom);\n  border-radius: 8px;\n  border-radius: var(--vscode-highlight-border-radius);\n  font-feature-settings: normal;\n}\n\n.vscode-highlight-code {\n  display: inline-block;\n  min-width: 100%;\n}\n\n.vscode-highlight-line {\n  display: inline-block;\n  box-sizing: border-box;\n  width: 100%;\n  padding-left: 1.5rem;\n  padding-left: var(--vscode-highlight-padding-left);\n  padding-right: 1.5rem;\n  padding-right: var(--vscode-highlight-padding-right);\n}\n\n.vscode-highlight-line-highlighted {\n  background-color: var(--vscode-highlight-line-highlighted-background-color);\n  box-shadow: inset var(--vscode-highlight-line-highlighted-border-width) 0 0 0 var(--vscode-highlight-line-highlighted-border-color);\n}\n\n  .light-default-light {\nbackground-color: #FFFFFF;\ncolor: #000000;\n}\n\n.light-default-light .mtk1 { color: #000000; }\n.light-default-light .mtk2 { color: #FFFFFF; }\n.light-default-light .mtk3 { color: #008000; }\n.light-default-light .mtk4 { color: #0000FF; }\n.light-default-light .mtk5 { color: #811F3F; }\n.light-default-light .mtk6 { color: #FF0000; }\n.light-default-light .mtk7 { color: #09885A; }\n.light-default-light .mtk8 { color: #0451A5; }\n.light-default-light .mtk9 { color: #267F99; }\n.light-default-light .mtk10 { color: #795E26; }\n.light-default-light .mtk11 { color: #800000; }\n.light-default-light .mtk12 { color: #001080; }\n.light-default-light .mtk13 { color: #CD3131; }\n.light-default-light .mtk14 { color: #AF00DB; }\n.light-default-light .mtk15 { color: #D16969; }\n.light-default-light .mtk16 { color: #000080; }\n.light-default-light .mtk17 { color: #A31515; }\n.light-default-light .mtk18 { color: #000000FF; }\n.light-default-light .mtki { font-style: italic; }\n.light-default-light .mtkb { font-weight: bold; }\n.light-default-light .mtku { text-decoration: underline; text-underline-position: under; }\n</style>","frontmatter":{"path":"/blog/db-locking-as-pro","title":"DB locking as a pro","author":"Hameed","date":"2022-11-12","tags":"locks,db,mysql,postgresql,pesmistic,concurrency"}}},"pageContext":{}},"staticQueryHashes":["1942870523","2605414244","3649515864","63159454"]}